<!DOCTYPE html>

<!-- モーダル -->
<div id="storyModal" class="stories modal">
    <!-- Toast Container -->
    <div class="toast-wrapper">
        <div id="toast-container" class="toast-message" ></div>
    </div>
    <div class="stories-modal-content modern">
        <span class="close" onclick="closeStoryModal()">&times;</span>
        <!-- Form -->
        <form method="POST" enctype="multipart/form-data" action="{% url 'stories:create' %}" class="stories-form">
            {% csrf_token %}

            <div class="stories-input-wrapper">
                <label for="id_media" class="upload-label">
                    <span>＋ ビデオを選択</span>
                    <input id="id_media" type="file" name="media" accept="video/*" onchange="previewStory(this)">
                </label>
            </div>

            <div id="preview" class="media-preview"></div>

            <div class="caption-wrapper">
                <textarea name="caption" id="id_caption" rows="3" placeholder="キャプションを追加..."></textarea>
            </div>
            <!-- ✅ プログレスバー追加 ダミー -->
            <div class="progress-wrapper">
                <progress id="uploadProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
            </div>

            <div class="stories-btn-wrapper">
                <button type="submit" class="btn-post">投稿</button>
            </div>
        </form>
    </div>
</div>


<div class="stories-wrapper">
  <div class="stories-scroll">
        <!-- 自分の追加ボタン -->
        <div class="story-user-wrapper">
            <div class="story-ring-myself" onclick="openStoryModal()">
                <img src="{{ request.user.profile.image.url }}" class="story-user-icon" />
                <span class="add-icon">＋</span>
            </div>
            <p class="story-username">ストーリーズ</p>
        </div>
        <!-- 他ユーザー&自身ののストーリー表示 -->
        <div class="story-list">
            {% for story in story_users %}
                <div class="story-user-wrapper">
                    <a href="#" onclick="openStoryViewModal({{ story.user.id }})">
                        <div class="story-ring {% if story.is_read %}read{% endif %}" data-story-id="{{ story.id }}">
                            <img src="{{ story.user.profile.image.url }}" class="story-user-icon" />
                        </div>
                        <p class="story-username-other">
                            {% if story.user == request.user %}
                                <a href="#" class="story-delete-link" data-url="{% url 'stories:story_delete_ajax' story.id %}">削除</a>
                            {% else %}
                                {{ story.user.username|truncatechars_html:10 }}
                            {% endif %}
                        </p>
                    </a>
                </div>
            {% endfor %}
        </div>
  </div>
</div>
<!-- form submit & progress bar-->
<script>
function showToast(message, type = "error") {
  const toast = document.getElementById("toast-container");

  toast.textContent = message;
  toast.classList.remove("toast-success", "toast-error");

  if (type === "success") {
    toast.classList.add("toast-success");
  } else {
    toast.classList.add("toast-error");
  }

  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
    toast.textContent = "";
    toast.classList.remove("toast-success", "toast-error");
  }, 3000);
}

let fakeProgressInterval = null;
let currentFakeProgress = 0;

function startFakeProgress(progressBar) {
  currentFakeProgress = 0;
  fakeProgressInterval = setInterval(() => {
    if (currentFakeProgress < 95) {  // 最大95%まで
      currentFakeProgress += 1;
      progressBar.value = currentFakeProgress;
    }
  }, 50);  // 50msごとに+1（= 約5秒で95%）
}

function stopFakeProgress(progressBar) {
  clearInterval(fakeProgressInterval);
  progressBar.value = 100;
}

document.querySelector(".stories-form").addEventListener("submit", function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const progressBar = document.getElementById("uploadProgress");

  progressBar.value = 0;
  progressBar.style.display = "block";

  startFakeProgress(progressBar);  // ⬅️ ダミープログレス開始

  const xhr = new XMLHttpRequest();
  xhr.open("POST", form.action, true);

  // 本物の進捗が使えれば上書き
  xhr.upload.onprogress = function (event) {
    if (event.lengthComputable) {
      const percent = (event.loaded / event.total) * 100;
      progressBar.value = percent;
    }
  };

  xhr.onload = function () {
    stopFakeProgress(progressBar);  // ⬅️ ダミープログレス停止
    progressBar.style.display = "none";

    try {
      const res = JSON.parse(xhr.responseText);
      if ((xhr.status === 200 || xhr.status === 302) && !res.error) {
        showToast("アップロード完了！", "success");
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(res.error || "アップロードに失敗しました", "error");
      }
    } catch (e) {
      showToast("不明なエラーが発生しました", "error");
    }
  };

  xhr.onerror = function () {
    stopFakeProgress(progressBar);
    progressBar.style.display = "none";
    showToast("通信エラーが発生しました", "error");
  };

  xhr.send(formData);
});
</script>


<!-- Story Delete -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.story-delete-link').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            if (!confirm('このストーリーを削除してもよろしいですか？')) return;

            const storyId = this.dataset.storyId;
            const deleteUrl = this.dataset.url;

            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Accept': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    this.closest('.story-user-wrapper').remove();
                } else {
                    alert(data.message || '削除できませんでした。');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラーが発生しました。');
            });
        });
    });
});
</script>