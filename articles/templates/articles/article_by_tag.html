<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}#{{ tag }}{% endblock %}
{% block headerName %}#{{ tag }}{% endblock %}
{% block mobileCenter %}<p class="mobile-center-name">#{{ tag }}</p>{% endblock %}
{% block content %}

<!-- ‚úÖ „ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´‰Ωø„ÅÜ„É¢„Éº„ÉÄ„É´Êû†ÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ -->
<div id="hashtagModal" class="hashtag-modal">
  <div class="hashtag-modal-content">
        <span id="hashtagModalClose" class="hashtag-modal-close">&times;</span>

        <!-- üîπ Â∑¶„Ç´„É©„É† -->
        <div class="left-info">
            <div class="swiper-container modal-swiper">
                <div class="swiper-wrapper" id="modalSwiperWrapper"></div>
                <div class="swiper-button-prev modal-swiper-button">
                    <span><i class="fas fa-chevron-left"></i></span>
                </div>
                <div class="swiper-button-next modal-swiper-button">
                    <span><i class="fas fa-chevron-right"></i></span>
                </div>
            </div>
        </div>

        <!-- üîπ Âè≥„Ç´„É©„É† -->
        <div class="right-info">
            <!-- „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†± -->
            <div class="user-info">
                <a id="modalUserLink" href="#">
                    <img id="modalUserIcon" class="user-icon" alt="User Icon" />
                </a>
                <span id="modalUserName" class="user-name"></span>
            </div>
            <div id="modalArticleBody" class="article-body-scrollable"></div>
        </div>
    </div>
</div>

<!-- ÂàùÊúüË®≠ÂÆö -->
<!-- ÂàùÊúüË°®Á§∫ÂàÜ„ÅØ partial „Å´ article Âçò‰Ωì„ÇíÊ∏°„Åô -->
<div id="articleListContainer" class="hashtag-grid" data-tag="{{ tag|escapejs }}">
    {% for article in articles %}
        {% include "articles/partial_article_tag_item.html" with article=article %}
    {% endfor %}
</div>

<!-- üëáÁõ£Ë¶ñÂØæË±°„ÅÆ„ÉÄ„Éü„ÉºË¶ÅÁ¥† -->
<!-- <div id="scrollObserverTarget"></div> -->
<div id="scrollObserverTarget" style="height: 40px;"></div>
<!-- end massage -->
<div class="hashtag-grid-end-message">
    <div id="loader">
        {% include 'articles/snippet/spinner.html' %}
    </div>
    <div class="end-icon-wrapper" style="display: none;">
        <div class="gradient-border">
            <div class="gradient-border-inner">
                <div class="end-circle-check">
                    <i class="fas fa-check"></i>
                </div>
            </div>
        </div>
    </div>
    <p class="end-message" style="display: none;">‰ª•‰∏ä„Åß„Åô</p>
</div>
<footer class="global-footer"></footer>
<script>
    // ‚úÖ window „Å´ÂÖ•„Çå„Å¶„Ç∞„É≠„Éº„Éê„É´„Å´„Åô„Çã
    window.articleData = {
        {% for article in articles %}
            "{{ article.id }}": {
                images: [
                    {% for img in article.images.all %}
                        "{{ img.image.url|escapejs }}",
                    {% endfor %}
                ],
                userIcon: "{{ article.author.profile.image.url|escapejs }}",
                userName: "{{ article.author.username|escapejs }}",
                body: `{{ article.body|linebreaksbr|escapejs }}`,
                userProfileUrl: "{% url 'articles:user-posts' article.author.username %}"
            },
        {% endfor %}
    };

    // ‚úÖ „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèË®≠ÂÆöÔºà‰ªñ„Åã„Çâ„ÇÇÂëº„Åπ„Çã„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
    window.setupModalEventDelegation = function (articleData) {
        const modal = document.getElementById("hashtagModal");
        const modalUserIcon = document.getElementById("modalUserIcon");
        const modalUserName = document.getElementById("modalUserName");
        const modalArticleBody = document.getElementById("modalArticleBody");
        const modalClose = document.getElementById("hashtagModalClose");
        const swiperWrapper = document.getElementById("modalSwiperWrapper");
        const container = document.getElementById("articleListContainer");

        let swiperInstance = null;

        container.addEventListener("click", (event) => {
            const thumb = event.target.closest(".hashtag-thumbnail");
            if (!thumb) return;

            const articleId = thumb.dataset.articleId;
            const data = articleData[articleId];
            if (!data) return;

            swiperWrapper.innerHTML = "";
            data.images.forEach(url => {
                const slide = document.createElement("div");
                slide.className = "swiper-slide";
                slide.innerHTML = `<img src="${url}" class="tag-slide-img">`;
                swiperWrapper.appendChild(slide);
            });

            modal.style.display = "flex";
            document.querySelector(".modal-swiper").style.height = "300px";

            setTimeout(() => {
                if (swiperInstance) swiperInstance.destroy(true, true);
                swiperInstance = new Swiper(".modal-swiper", {
                    loop: false,
                    slidesPerView: 1,
                    navigation: {
                        nextEl: ".swiper-button-next.modal-swiper-button",
                        prevEl: ".swiper-button-prev.modal-swiper-button"
                    }
                });
                swiperInstance.update();
            }, 100);

            const prevButton = document.querySelector(".swiper-button-prev.modal-swiper-button");
            const nextButton = document.querySelector(".swiper-button-next.modal-swiper-button");
            const multipleImages = data.images.length > 1;
            prevButton.style.display = multipleImages ? "flex" : "none";
            nextButton.style.display = multipleImages ? "flex" : "none";

            modalUserIcon.src = data.userIcon;
            modalUserIcon.parentElement.href = data.userProfileUrl;
            modalUserName.textContent = data.userName;
            modalArticleBody.innerHTML = data.body;
        });

        modalClose.addEventListener("click", () => {
            modal.style.display = "none";
        });

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÔºàÂü∫Êú¨Ôºâ
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
    };

    // ‚úÖ DOM„ÅåÊ∫ñÂÇô„Åß„Åç„Åü„Çâ1Â∫¶„Å†„ÅëÂëº„Å∂
    document.addEventListener("DOMContentLoaded", function () {
        setupModalEventDelegation(window.articleData);
    });
</script>
<!-- <script src="/static/js/tag_infinite_scroll.js" defer></script> -->
 <script>
    // console.log("üìú tag_infinite_scroll.js loaded");
    document.addEventListener("DOMContentLoaded", function () {
        // console.log("‚úÖ DOMContentLoaded fired");
    let currentPage = 2;
    let isLoading = false;
    let hasNextPage = true;

    const container = document.getElementById("articleListContainer");
    const observerTarget = document.getElementById("scrollObserverTarget");
    const loader = document.getElementById("loader");
    const endMessage = document.querySelector(".end-message");
    const endMessageCircle = document.querySelector(".end-icon-wrapper");
    const tagSlug = container.dataset.tag;

    const articleIdsShown = new Set();

    document.querySelectorAll(".hashtag-thumbnail").forEach(el => {
        const id = el.dataset.articleId;
        if (id) articleIdsShown.add(id);
    });

    // üîπ callback„ÇíÂÖà„Å´ÂÆöÁæ©
    function callback(entries) {
        entries.forEach(entry => {
            // console.log("Observer callback triggered. isIntersecting:", entry.isIntersecting);
            // console.log("isLoading:", isLoading, "hasNextPage:", hasNextPage);

            if (entry.isIntersecting && !isLoading && hasNextPage) {
                // console.log("‚Üí loadMore() Âëº„Å≥Âá∫„Åó");
                loadMore();
            }
        });
    }

    // üîπ callbackÂÆöÁæ©Âæå„Å´observer‰ΩúÊàê
    const observer = new IntersectionObserver(callback, { 
        root: null, 
        threshold: 0.5 
    });

    if (observerTarget) {
        observer.observe(observerTarget);
        // console.log("üëÅÔ∏è Observer is now observing:", observerTarget);
    } else {
        // console.warn("#scrollObserverTarget not found");
    }

    // --- ‰ª•‰∏ã loadMore ÂÆöÁæ© ---
    function loadMore() {
        if (isLoading || !hasNextPage) return;

        isLoading = true;
        loader.style.display = "block";

        fetch(`/articles/tags/${encodeURIComponent(tagSlug)}/?page=${currentPage}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            // console.log("Fetched data:", data);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = data.html;

            tempDiv.querySelectorAll(".hashtag-thumbnail").forEach(el => {
                const id = el.dataset.articleId;
                if (!articleIdsShown.has(id)) {
                    container.appendChild(el);
                    articleIdsShown.add(id);
                }
            });

            if (data.has_next) {
                currentPage += 1;
            } else {
                hasNextPage = false;
                endMessage.style.display = "block";
                endMessageCircle.style.display = "block";
            }
        })
        .catch(err => {
            console.error("Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:", err);
        })
        .finally(() => {
            loader.style.display = "none";
            isLoading = false;
        });
    }
});
 </script>
{% endblock %}
